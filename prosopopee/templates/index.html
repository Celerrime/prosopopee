<html>

<head>
<link rel="stylesheet" href="/static/css/codemirror.css">
<link rel="stylesheet" href="/static/css/materialize.min.css">
<link rel="stylesheet" href="/static/css/icons.css">
<link rel="stylesheet" href="/static/css/style.css">
<link rel="stylesheet" href="/static/css/dracula.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<script src="/static/js/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="></script>
<script src="/static/js/jquery.form.min.js"></script>
<script src="/static/js/jquery.hotkeys.js"></script>
<script src="/static/js/materialize.min.js"></script>
<script src="/static/js/codemirror.js"></script>
<script src="/static/js/mode/yaml/yaml.js"></script>

</head>
<body>
  <main>

  <div class="fixed-action-btn toolbar" style="top: 10px; right: 24px;">
    <a href="#" data-activates="slide-out" class="btn-floating btn-large red"><i class="material-icons">edit</i></a>
    </a>
  </div>

  <ul id="slide-out" class="side-nav">
    <div class="content" style="background-color: #282a36;">
      <div id="editZone">
        <form id="saveForm">
          <a class="waves-effect waves-light btn" href="#modal1">
            <i class="material-icons right">library_add</i>new gallery
          </a>
          <textarea class="materialize-textarea" name="settings" id="editor"></textarea>
          <button class="waves-effect waves-light btn" type="submit" name="action" id="save">
            <i class="material-icons right">send</i>save
          </button>
        </form>
      </div>

      <div id="imagesZone">
        <form id="uploadImagesForm" enctype="multipart/form-data" method="post" name="uploadImagesForm" action="/upload_images/">
          <button id="uploadImagesButton" type="button" class="btn waves-effect waves-light" style="width: 100%;">add more images
            <i class="material-icons right">perm_media</i>
          </button>
          <input id="uploadImagesInput" type="file" name="images" multiple style="display: none">
          <input id="uploadImagesPath" name="path" type="hidden">
        </form>
        <div id="currentGalleryImages">
        </div>
      </div>
    </div>
  </ul>

  <div id="prosopopeeHtml">
    <iframe id="buildIframe" src="build/" onLoad='iframeSrcChanged(this);'>
    </iframe>
  </div>

  <!-- Modal Structure -->
  <div id="modal1" class="modal modal-fixed-footer">
    <form id="form_newone">
      <div class="modal-content">
        <div class="input-field">
          <input id="folder" type="text" class="validate">
          <label for="folder">Folder</label>
        </div>
        <div class="input-field">
          <input id="title" type="text" class="validate">
          <label for="title">Title</label>
        </div>
        <div class="file-field input-field">
          <div class="btn">
            <span>File</span>
            <input id="cover" type="file">
          </div>
          <div class="file-path-wrapper">
            <input class="file-path validate" type="text">
          </div>
        </div>
        <div class="input-field">
          <input id="date" type="date" class="datepicker">
          <label id=date for="date">Date</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="waves-effect waves-light btn" id="newGallery">Save</button>
      </div>
    </form>
  </div>

  <script>
var context = {
  "current_gallery": "/build/",
  "current_images": "",
  "CodeMirror": null
}

$(function() {
  // init
  var _theframe = document.getElementById("buildIframe");
  _theframe.contentWindow.location.href = _theframe.src;

  // url changed in frame
  iframeSrcChanged = function(iframe) {
    console.log("-> " + context["current_gallery"]);
    context["current_gallery"] = iframe.contentWindow.location.pathname
      $.get("/settings" + context["current_gallery"] + "?_=" + (new Date).getTime()).done(function(data) {
        if (context.CodeMirror === null) {
          context.CodeMirror = CodeMirror.fromTextArea(document.getElementById("editor"), {mode: "yaml", theme: "dracula"})
        }
        context.CodeMirror.setValue(data);
      })

    if (context["current_gallery"] != "/build/") {
      $("#imagesZone").addClass("active");
      updateGalleryImages(context["current_gallery"]);
    } else {
      $("#imagesZone").removeClass("active");
    }
  }

  var updateGalleryImages = function(path) {
    $("#currentGalleryImages").html('<div class="loader"></div>').addClass("loading");
    $.get("/images" + path).done(function(data) {
      $("#currentGalleryImages").html(data).removeClass("loading");
      if (data != context["current_images"]) {
        context["current_images"] = data;
      }
    })
  }

  // update settings
  var save = function(event) {
    event.preventDefault();
    $("#save").addClass("loading").html("saving...");
    $.post("/save_settings" + context["current_gallery"], $("#saveForm").serialize())
      .done(function() {
        // dirty hack for save data
        $.post("/save_settings" + context["current_gallery"], $("#saveForm").serialize())
          $("#save").removeClass("loading").html("save");
        document.getElementById('buildIframe').contentWindow.location.reload();
      });
    updateGalleryImages(context["current_gallery"]);
  }

  $("#saveForm").submit(save);
  $("#editor").on('keydown', null, 'ctrl+s', save);


  $("#newGallery").click(function() {
    var folder_name = document.getElementById("folder").value;
    if (folder_name === null) return;
    var title = document.getElementById("title").value;
    if (title === null) return;
    var date = document.getElementById("date").value;
    if (date === null) return;
    var cover = document.getElementById("cover").files[0].name;
    if (cover === null) return;

    if (confirm("Are those correct?\nFolder name: " + folder_name + "\nTitle : " + title + "\nDate : " + date + "\nCover : " + cover)) {
      $.post("/new_gallery/", {folder_name: folder_name, title: title, date: date, cover: cover})
        .done(function(data) {
          // TODO doesn't support sub_galleries
          _theframe.contentWindow.location.href = _theframe.baseURI + "build/" + folder_name + "/";
          context["current_gallery"] = iframe.contentWindow.location.pathname
        })
    }
    // Fix upload file
    // $.post("/upload_images/", $("#cover").serialize());
    $('#modal1').modal('close');
    $('.btn-floating').sideNav('show');
  })

  $("#uploadImagesButton").click(function() {
    $("#uploadImagesPath").val(context["current_gallery"]);
    $("#uploadImagesInput").click();
    // console.log($("#uploadImagesForm").serialize());
    // $.post("/upload_images" + context["current_gallery"], $("#uploadImagesForm").serialize());
  })

  $("#uploadImagesInput").on("change", function() {
    console.log("prout");
    $("#uploadImagesForm").ajaxForm().submit();
    updateGalleryImages(context["current_gallery"]);
  })

})

$('.btn-floating').sideNav({
  menuWidth: '70%',
  edge: 'left',
  closeOnClick: true,
}
);

$(document).ready(function() {
  $('select').material_select();
});

$(document).ready(function(){
  $('.modal').modal();
});

$('.datepicker').pickadate({
  selectMonths: true,
  selectYears: 17,
  format: 'yyyy-mm-dd'
});

  </script>
  </main>
</body>
